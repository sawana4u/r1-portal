<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | R1 Tech Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;800&display=swap'); body { font-family: 'Outfit', sans-serif; }</style>
</head>
<body class="bg-slate-50 min-h-screen">
    
    <header class="bg-slate-900 p-5 text-white flex justify-between items-center shadow-xl sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <h1 class="font-black uppercase tracking-tighter text-lg">R1 Dashboard</h1>
        </div>
        <div class="flex items-center gap-3">
            <a href="profile.html" class="bg-slate-800 p-2.5 rounded-xl border border-slate-700 hover:bg-indigo-600 transition-all"><i data-lucide="user" class="w-5 h-5"></i></a>
            <button onclick="logout()" class="bg-slate-800 p-2.5 rounded-xl border border-slate-700 hover:bg-red-600 transition-all"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black">Service History</h2>
            <a href="editor.html" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase shadow-xl">+ New SRF Lot</a>
        </div>
        
        <div id="lotList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Lots will be injected here -->
        </div>

        <div id="noRecords" class="hidden py-20 text-center text-slate-300">
            <i data-lucide="inbox" class="w-16 h-16 mx-auto mb-4 opacity-20"></i>
            <p class="font-bold uppercase tracking-widest text-xs">No records found yet</p>
        </div>
    </main>

    <script type="module">
        import { auth, db, APP_ID } from './config.js';
        import { onAuthStateChanged, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        onAuthStateChanged(auth, u => {
            if(!u) window.location.href = 'index.html';
            else fetchHistory(u.email);
        });

        function fetchHistory(email) {
            const list = document.getElementById('lotList');
            const noRec = document.getElementById('noRecords');
            const ref = collection(db, 'artifacts', APP_ID, 'public', 'data', 'srf_lots');
            
            onSnapshot(ref, snap => {
                list.innerHTML = '';
                const myLots = snap.docs.filter(d => d.data().userEmail === email);
                
                if(myLots.length === 0) noRec.classList.remove('hidden');
                else {
                    noRec.classList.add('hidden');
                    // Sorting: Latest first
                    myLots.sort((a,b) => (b.data().createdAt?.seconds || 0) - (a.data().createdAt?.seconds || 0)).forEach(d => {
                        const l = d.data();
                        const id = d.id;
                        list.innerHTML += `
                            <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm">
                                <h3 class="text-2xl font-black text-indigo-600 uppercase tracking-tighter">${l.srfId}</h3>
                                <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 mb-6">${l.createdAt ? new Date(l.createdAt.toDate()).toDateString() : 'Syncing'}</p>
                                <div class="bg-slate-50 p-5 rounded-2xl text-xs font-black text-slate-800 mb-6 flex justify-between">
                                    <span>Quantity:</span> <span>${l.total} Instruments</span>
                                </div>
                                <a href="editor.html?id=${id}" class="block text-center w-full py-4 border-2 border-slate-100 rounded-2xl text-[10px] font-black uppercase hover:bg-slate-900 hover:text-white transition-all">View / Edit Record</a>
                            </div>`;
                    });
                }
                lucide.createIcons();
            });
        }

        window.logout = () => firebaseSignOut(auth).then(() => window.location.href = 'index.html');
    </script>
</body>
</html>


